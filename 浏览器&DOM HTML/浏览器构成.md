---
date created: 2021-12-09 22:58
date updated: 2021-12-17 14:51
---

#browser

## 进程与线程

**进程: 进程就是一个程序的运行实例**

**线程: 可以理解为执行任务的队列**

以前的浏览器是单进程的产物, 页面渲染, JS 执行, 插件, 网路之类的都运行在同一个进程中, 会导致一下几个问题:

1. **不稳定**, 早期浏览器借助插件来实现 web 功能, 插件是比较容易出问题的, 比如 IE 的 Activat 什么什么插件, 很容易崩溃, 一旦出问题就会引起整个浏览器的崩溃
2. **不流畅**, 因为页面渲染, JS 执行都在同一线程中, 意味着同一个时间段只能有一个模块可以执行, 挤占了其它任务执行的时间, 导致很多页面出现失去相应, 变卡顿等.
3. **不安全**, 插件用 C++等语言编写, 这就使插件可以获取到操作系统的任意资源, 没有沙箱隔离机制, 浏览器安全就形同虚设

## 多进程浏览器(以 chrome 为代表)

现代浏览器一般采用多进程架构, 以 chrome 为例, 在浏览器中主要有以下几个进程:

1. **浏览器主进程** : 主要负责界面显示, 用户交互, 子进程管理, 提供用户存储等功能
2. **渲染进程(GPU 进程)** : 页面显示的关键进程, 主要将 HTML, CSS, javaScript 转化为页面, 使用排版引擎和 JS V8 引擎处理该类工作, 默认情况下, chrome 的一个 tab 就是一个渲染进程. 渲染进程运行在沙箱模式下. 该进程下又包含了以下几种重要的线程
   1. **GUI 渲染线程**
   2. **JS 引擎线程** 有 V8 引擎
   3. **事件触发线程** 与 EventLoop 密切相关
   4. **定时触发器线程**
   5. **异步 HTTP 请求线程**

> **GUI 渲染线程**与**JS 引擎线程**是互斥的, 为了防止 DOM 渲染的不一致性, 其中一个线程执行期间另一个线程会被挂起, 这里两个线程也涉及到 Vue 中的 [[Vue $nextTick]]
> [[JS 引擎线程和事件触发线程]]

3. GPU 进程 : 最初为了实现 3D CSS, 后来 UI 页面也使用 GPU 进行渲染, 所以有了这个进程, 其实同上
4. **网络进程** : 主要负责网络资源加载, 也就是 network 面板里面看到的所有服务端资源请求都是由该进程负责
5. 插件进程 : 负责插件运行, 插件有奔溃的风险, 所以单独拎出来为一个进程做隔离, 保证页面和浏览器不会受插件出问题而影响

## 从输入 URL 开始发生的步骤

- 输入 URL , 解析 URL , 组装协议, 构成完整 URL
- **浏览器进程**通过进程间通信(IPC) 把 URL 请求发送给**网络进程**
- **网络进程**接收到 URL 请求后检查本地缓存查看资源缓存情况, 进行资源返回或者重新请求服务器资源
- 如果需要进行服务器发起 HTTP 请求, 则走如下流程
  - 进行 DNS 解析, 获取服务器 IP 地址
  - 建立 TCP 连接
  - 构建请求头, 发送请求头
  - 服务器响应, 浏览器接收资源然后解析资源
- 准备**渲染进程**
  - **浏览器进程**检查当前 URL 是否和已打开的 tab 页面是否 same-site, 如果相同, 则复用已有的进程, 如果不同, 则开启新的**渲染进程**
- 传输数据, 更新状态
  - **渲染进程**准备好之后, 浏览器向渲染进程发起"提交文档"的消息, 渲染进程接收到消息后和网络进程建立传输数据的"管道"
  - **渲染进程** 接收完数据后, 向浏览器进程发送"确认提交"
  - **浏览器进程**接收到确认消息后更新浏览器界面状态, 有以下: 安全, 地址栏 URL, 页面栈历史状态, 更新 web 页面
  -

[浏览器工作原理与实践](https://blog.poetries.top/browser-working-principle/)
