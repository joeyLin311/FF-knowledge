---
date created: 2021-12-09 22:56
date updated: 2021-12-17 16:11
---

#Network

#### HTTPS 出现的原因

HTTPS 出现是因为 HTTP 传输的内容是**明文传输**, 没有经过任何加密, 在传输的过程中的任意节点都可能被监听, 传输内容会被完全暴露, 有一种攻击方法就是**中间人攻击**(Man In The Middle), 还有运营商劫持, 严重影响用户体验.[[前端安全]]

#### HTTPS 实现原理

HTTPS 就是通过 **SSL/TLS 加密**数据包后的 HTTP 通信.

- SSL - Secure Sockets Layer 安全套接层
- TLS - Transport Layer Security 传输层安全协议

**传输-加密过程**

1. 用户在浏览器发起 HTTPS 请求(如 <https://www.mogu.com/>) 默认使用服务端的 443 端口进行连接；

2. HTTPS 需要使用一套**CA 数字证书**，证书内会附带一个**公钥 Pub**，而与之对应的**私钥 Private **保留在服务端不公开；

3. 服务端收到请求，返回配置好的包含**公钥 Pub **的证书给客户端；

4. 客户端收到证书，校验合法性，主要包括是否在有效期内、证书的域名与请求的域名是否匹配，上一级证书是否有效（递归判断，直到判断到系统内置或浏览器配置好的根证书），如果不通过，则显示 HTTPS 警告信息，如果通过则继续；

5. 客户端生成一个用于**对称加密**的随机 Key，并用证书内的**公钥 Pub**  进行加密，发送给服务端

6. 服务端收到随机 Key 的密文，使用与公钥 Pub 配对的 **私钥 Private ** 进行解密，得到客户端真正想发送的 **随机 Key**；

7. 服务端使用客户端发送过来的随机 Key 对要传输的 HTTP 数据进行**对称加密**，将密文返回客户端；

8. 客户端使用随机 Key **对称解密**密文，得到 HTTP 数据明文；

9. 后续 HTTPS 请求使用之前交换好的随机 Key 进行**对称加解密**。

#### 对称加密和非对称加密

- **对称加密**指的是有一个密钥, 用它可以对一段明文加密, 加密之后也只能用该密钥来解密获得明文, 如果通信双方都有密钥, 且不被第三方知晓, 那么通信间的安全性是可以得到保证的.

- 这个时候服务端发送的客户端对象事先是不知道, 需要事先传输密钥, 还是会暴露

- **非对称加密**, 有两个密钥, 一个公钥, 一个私钥. 如果用公钥对数据进行加密, 只有用对应的私钥才能解密; 如果用私钥对数据进行加密, 那么只有用对应的公钥才能解密

- **非对称加密的算法是 RSA 算法**

#### SSL/TLS 握手过程图解
[[TLS握手协议]]
1.  客户端发出一个 client hello 消息，携带的信息包括：所支持的 SSL/TLS 版本列表；支持的与加密算法；所支持的数据压缩方法；随机数 A。
2.  服务端响应一个 server hello 消息，携带的信息包括：协商采用的 SSL/TLS 版本号；会话 ID；随机数 B；服务端数字证书 serverCA；由于双向认证需求，服务端需要对客户端进行认证，会同时发送一个 client certificate request，表示请求客户端的证书。
3.  客户端校验服务端的数字证书；校验通过之后发送随机数 C，该随机数称为 pre-master-key，使用数字证书中的公钥加密后发出；由于服务端发起了 client certificate request，客户端使用私钥加密一个随机数 clientRandom 随客户端的证书 clientCA 一并发出。
4.  服务端校验客户端的证书，并成功将客户端加密的随机数 clientRandom 解密；根据随机数 A/随机数 B/随机数 C（pre-master-key） 产生动态密钥 master-key，加密一个 finish 消息发至客户端。
5.  客户端根据同样的随机数和算法生成 master-key，加密一个 finish 消息发送至服务端。
6.  服务端和客户端分别解密成功，至此握手完成，之后的数据包均采用 master-key 进行加密传输。
![](https://cdn.nlark.com/yuque/0/2021/png/223223/1630652479947-3e73fe87-a112-4e70-8c61-5331dff44b6b.png)

#### HTTPS 加密, 解密, 验证及数据传输过程

![](https://cdn.nlark.com/yuque/0/2021/png/223223/1630653708853-4692aad1-418a-40e8-afe7-28d165b55bff.png)
