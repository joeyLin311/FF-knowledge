---
date created: 2022-05-30 22:51
---
#Network
## TCP keepAlive

TCP keepAlive 又称 TCP 的保活机制. 保活机制默认是关闭的, TCP 连接的任何一方都可以打开次功能, 有三个配置参数可用用来控制保活功能

如果在一段时间(**保活时间 tcp_keepalive_time**) 中此次连接都不活跃, 开启保活功能的一段会向对方发送一个保活探测报文

- 如果对方正常存活且连接有效, 对端可以正常收到探测报文并进行响应. 此时发送端获得正常连接的消息, 可以重置保活时间计数器
- 如果因为其它原因导致发送端无法正常收到探测报文的响应, 那么在一定的探测时间间隔(**tcp_keepalive_intvl**)后将继续发送探测报文, 直到有响应. 或者达到配置中探测循环次数(**tcp_keepalive_probes**)上限都没有收到响应的话, 发送端会认为该连接已经失效, 需要做连接中断处理

## HTTP keep-alive

HTTP 协议是运行在 TCP 协议之上的无状态应用层协议, 其特点是: 客户端的每次请求都要与服务端创建 TCP 连接, 服务端响应后, 断开 TCP 连接. 如果客户端有进一步的请求, 则再开启新的连接.

HTTP1.0 版本默认就是上述的请求-应答模式, 这种方法在网络活动中会频繁地创建和销毁连接, 造成了一定的性能损耗.

在 HTTP1.1 版本中, 引入了 keep-alive 机制, 默认开启, 如果关闭要设置 `Connection: close` 关闭.

keep-alive 机制: 开启之后在一次 HTTP 请求中, 服务器进行响应后, 不会断开 TCP 连接, 而是将 TCP 连接维持一段时间. 在这段时间内如果客户端发起新的 HTTP 请求, 会复用原有的 TCP 连接, 并重置 timeout 计数器. 这样的机制避免的了 HTTP1.0 中反复创建销毁 TCP 连接的性能开销.
![[HTTP keep-alive 图示.jpg]]

## 总结

1.  TCP 连接就是理解的广义上的场链接, 它具备双端连续收发报文的能力; 开启了 keep-alive 的 HTTP 连接也是一种长连接, 但是因为协议的限制, 服务端无法主动发起应用报文.
2.  TCP 中的 keepAlive 是用来保活的; HTTP 的 keep-alive 是为了支撑 TCP 连接存活的时间更持久, 所以也可以称为: HTTP 持久连接 和 HTTP 连接重用
3.  HTTP 的 keep-alive 无论开启与否, TCP 连接的断开是由服务端决定的, **通常由服务端主动关闭连接**
