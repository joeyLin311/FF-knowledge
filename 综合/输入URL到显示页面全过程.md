---
date created: 2022-05-24 01:14
---

## 概括

浏览器从输入网址到显示页面主要分为以下几个过程:

- URL 输入->DNS解析
- 建立 TCP 连接
- 发送 HTTP/HTTPS 请求 (建立TLS连接)
- 服务器发送响应请求
- 浏览器解析渲染页面
- HTTP 请求结束, 断开 TCP 连接

**以下是各部分的详细步骤**

## URL 输入

在浏览器键入URL(统一资源定位符, Uniform Resource Locator). 浏览器会对输入信息进行以下判断:

- 检查输入的内容是否为合法的 URL 链接
- 是, 则判断输入的 URL 是否完整. 如果不完整, 浏览器会补全链接, 比如加上https 协议头.
- 否, 将输入内容作为搜索条件, 使用浏览器默认引擎进行字符串搜索

## DNS 解析

![[DNS 解析过程.png]]
浏览器不能直接通过域名找到对应的服务器 IP 地址, 所以需要进行 DNS 解析, 查找到网址对应的 IP 地址, 步骤如下:

1. 操作系统检查`浏览器缓存`和本地hosts文件中是否有输入网址的记录, 有则从记录里找到对应的 IP 地址, 完成域名解析
2. 查找`本地系统 DNS 缓存`器中是否有该网址记录, 有则从记录找到对应 IP 地址, 完成解析
3. 使用 TCP/IP 参数(`路由缓存`)中设置的 DNS 服务器进行查询. 如果要查询的域名包含在本地配置区域资源中, 则返回解析结果, 完成域名解析
4. 检查`本地 DNS 服务器(运营商ISPDNS缓存)`是否缓存该网址记录, 有则返回解析结果, 完成让域名解析
5. 本地 DNS 服务器发送查询报文至`根 DNS 服务器`, 根 DNS 服务器收到请求后, 用顶级域 DNS 服务器地址进行响应
6. 本地 DNS 服务器发送查询报文至`顶级域 DNS 服务器`. 顶级域 DNS 服务器收到请求后, 用权威 DNS 服务器地址进行响应
7. 本地 DNS 服务器发送查询报文至`权威 DNS 服务器`, 权威 DNS 服务器收到请求, 用键入域名的 IP 地址进行响应, 完成域名解析

DNS 查询通常遵循以上流程, **从请求主机到本地 DNS 服务器的查询是递归查询, DNS 服务器获取到所需映射的查询是迭代查询**

针对上述流程, 前端可以手动控制DNS解析 [[DNS 解析优化]]

## 建立 TCP 连接

> 世界上几乎搜索的 HTTP 通信都是由 TCP/IP 承载的, TCP/IP  是全球计算机及网络设备都在使用的一种常用的分组交换网络分层. HTTP 的连接实际上就是 TCP 连接以及其使用规则
> ---- <HTTP 权威指南>

当浏览器获取到服务器的 IP 地址后, 浏览器会用一个随机的端口向服务器 80 端口发起 TCP 连接请求(HTTPS协议默认端口是 443). 这个链接请求到达服务端后, 通过 [[TCP 协议#三次握手]] , 建立 TCP 连接

### 分层模型

| OSI模型      | TCP/IP模型 | 对应协议        |
| ---------- | -------- | ----------- |
| 应用层        | ---      | HTTP        |
| 表示层        | 应用层      | ---         |
| 会话层        | ---      |             |
| 传输层        | 传输层      | TCP UDP TLS |
| 网络层        | 网络层      |             |
| 数据链路层/ 物理层 | 链路层      |             |
| [OSI]      | [TCP/IP] |             |

## TLS 协商

![[TLS 协议.png]]
建立连接后就可以通过 HTTP 进行数据传输. 如果使用 HTTPS 协议, 会在 TCP 与 HTTP 之间多添加一层协议做加密及认证的服务.
HTTPS 使用 SSL (Secure Socket Layer) 和 TLS (Transport Layer Security) 协议, 保障了信息的安全

**SSL**

- 认证用户和服务器, 确保数据发送到正确的客户端和服务器
- 加密数据防止数据中途被窃取
- 维护数据的完整性, 确保数据再传输过程中不被改变

**TLS**

- 用于在两个通信应用程序之间提供保密性和数据完整性. 该协议由两层组成: TLS 记录协议(TLS Record) 和 TLS 握手协议(TLS Handshake). 较低层为TLS记录协议, 位于某个可靠的传输协议(例如TCP)上面

## TLS 握手协议

[[HTTPS 加密#SSL TLS 握手过程图解]]
这里进入 TLS 握手协议详情: [[TLS握手协议]]

## 服务器响应

当浏览器到 web 服务器的连接建立完成后, 浏览器会发送一个初始的 HTTP GET 请求, 请求的目标通常是一个 HTML 文件. 服务器收到请求后, 将返回一个 HTTP 响应报文, 内容包括响应头和 HTML 正文.

```html
<html>
 <head>
  <meta charset="UTF-8"/>
  <title>我的博客</title>
  <link rel="stylesheet" src="styles.css"/>
  <scrIPt src="index.js"></scrIPt>
</head>
<body>
  <h1 class="heading">首页</h1>
  <p>A paragraph with a <a href="https://hzfe.org/">link</a></p>
  <scrIPt src="index.js"></scrIPt>
</body>
</html>
```

常见的 HTTP 的请求头和字段相关说明 [[HTTP 缓存]]

- Cache-Control: must-revalidate\ no-cache \ private (是否需要缓存资源)
- Connection: keep-alive (保持连接)
- Content-Encoding: gzip (web服务器支持的返回内容压缩编码类型)
- Content-type: text/html: chartset=UTF-8 (文件类型和字符编码格式)
- Date: Sun, 22 Sep 2022 06:18:21 GMT (服务器消息发出时间)
- Transfer-Encoding: chunked (服务器发送的资源的方式是分块发送)

### 响应报文

响应报文由四部分组成:

- 状态行: HTTP 版本 + 空格 + [[HTTP 状态码]] + 空格 + 状态码描述 + 回车符(CR) + 换行符(LF)
- 响应头: 字段名 + 冒号 + 值 + 回车符 + 换行符
- 空行: 回车符 + 换行符
- 响应体: 由用户自定义添加, 如 `post` 的 `body` 等

## 浏览器解析并绘制

不同的浏览器渲染引擎过程都不太一样, 这里以 Chrome 渲染方式为例 [[浏览器渲染过程]]

## TCP 断开连接

现代网页为了优化请求的耗时, 默认都会开启持久性连接(`keep-alive`)[[HTTP keep-alive 和 TCP keepAlive]], 那么一个 TCP 连接确切关闭的时机, 是这个 tab 标签页关闭的时候. 这个关闭的过程就是 **TCP四次挥手**. 关闭是一个全双工的过程, 发包的顺序是不一定的, 一般来说是客户端主动发起关闭请求
[[TCP 协议#四次挥手]]
